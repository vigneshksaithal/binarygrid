# Binary Grid — System & Mechanics (LLM Reference)

This document explains the Binary Grid game's mechanics, constraints, validation, UX flow, backend API, data models, leaderboard, streaks, and reward system. It is written to be directly machine-ingestible by LLMs while remaining readable to engineers. All examples are canonical to this codebase.

## Core Concept

- **Goal**: Fill a 6×6 grid with 0s and 1s.
- **Input cycle**: tap a cell cycles null → 0 → 1 → null.
- **Given cells**: some cells are fixed and cannot be changed.
- **Win condition**: every cell is filled and all rules are satisfied. The app auto-submits.

## Rules (Hard Constraints)

Let SIZE = 6.

- **R1. No Triples**: No row or column contains any contiguous triple 000 or 111.
- **R2. Balanced Lines**: Each row and each column must contain exactly SIZE/2 zeros and SIZE/2 ones. With SIZE=6, each row and column contains exactly three 0s and three 1s.
- **R3. Uniqueness (UI guidance)**: The How-To explicitly states rows and columns should be different. Server validation accepts any grid that satisfies R1 and R2 and matches givens; uniqueness is enforced in the generator to produce valid puzzles and hinted in UI rules.
- **R4. Respect Givens**: Fixed cells provided by the puzzle cannot be changed, and submitted solutions must match them.

Server-side acceptance requires: correct shape (6×6), only 0/1 values (no nulls), givens match, and the grid conforms to R1, R2 (via `gridFollowsRules`).

## Grid Generation (Deterministic per day/difficulty)

- Size: 6×6.
- Seed: `"YYYY-MM-DD:difficulty"` (UTC date key).
- Algorithm: backtracking with partial constraints to construct a solution satisfying R1 and R2 across rows and columns. Deterministic RNG: Mulberry32 seeded by FNV-1a of the seed string.
- Givens: from the full solution, reveal a subset of cells based on difficulty-specific reveal ratios: easy 50%, medium 40%, hard 30%.
- ASCII Reward: generated by a seeded function from `"ascii:seed"`, shown after a win.

## Difficulty

- `easy`: ~50% cells given
- `medium`: ~40% cells given
- `hard`: ~30% cells given

All difficulties share the same rules; only clue density changes.

## Client Validation

- The client checks per-row and per-column status: `balanced` and `noTriples`.
- A line is `balanced` if counts of 0/1 do not exceed SIZE/2 during play, and if fully filled, they are equal.
- `noTriples` scans the line for any 3-length contiguous identical values.
- When all cells are filled and all line checks pass, the client auto-submits.

## Submission Semantics

- Submission payload: `{ grid: number[][], timeMs: number }`.
- Server acceptance:
  - shape: 6×6
  - all values are 0 or 1
  - givens match
  - `gridFollowsRules(grid)` is true (R1, R2)
- If valid: leaderboard update, streak update, rewards processing (async), best-time per user for the day/difficulty, and return rank/total.

## UX Flow (High-Level)

1. App fetches puzzle for selected difficulty; shows a loading overlay.
2. User edits non-fixed cells; timer runs while unsolved.
3. When the grid is full and passes client checks, the app auto-submits.
4. On success: confetti, ASCII modal (seeded), achievements update, leaderboard refresh.
5. Option to replay other difficulties from the modal.

## Data Shapes (Authoritative)

PuzzleInfo

```json
{
  "dateKey": "YYYY-MM-DD",
  "seed": "YYYY-MM-DD:difficulty",
  "size": 6,
  "difficulty": "easy|medium|hard",
  "givens": [[0,1,null,...], [...]],
  "asciiArt": "string"
}
```

SubmitRequest

```json
{ "grid": [[0,1,...],[...]], "timeMs": 12345 }
```

SubmitResult (success)

```json
{
  "ok": true,
  "valid": true,
  "timeMs": 12345,
  "rank": 7,
  "total": 42,
  "dateKey": "YYYY-MM-DD",
  "achievements": ["first_win", "top_10"],
  "rewardsAwarded": true
}
```

SubmitResult (invalid)

```json
{ "ok": false, "valid": false, "message": "Incorrect grid" }
```

LeaderboardEntry

```json
{ "username": "u123", "timeMs": 3210, "rank": 3 }
```

LeaderboardResponse

```json
{ "type": "leaderboard", "dateKey": "YYYY-MM-DD", "entries": [ ... ] }
```

StreakResponse

```json
{ "type": "streak", "username": "u123", "currentStreak": 5, "bestStreak": 12 }
```

UserAchievementsResponse

```json
{
  "type": "achievements",
  "username": "u123",
  "achievements": ["first_win", "speed_demon"],
  "flairText": "optional"
}
```

## HTTP API (Server)

- GET `/api/puzzle?difficulty=easy|medium|hard`
  - Returns: `PuzzleResponse` with deterministically generated givens and ASCII art.

- POST `/api/submit?difficulty=...`
  - Body: `SubmitRequest`
  - Returns: `SubmitResult` with rank and total on success; errors otherwise.
  - Side effects: updates daily leaderboard, streaks, queues rewards processing, best-effort Reddit comments.

- GET `/api/leaderboard?difficulty=...`
  - Returns: `LeaderboardResponse` (top 50 for day+difficulty).

- GET `/api/streak`
  - Returns: `StreakResponse` for current user.

- GET `/api/howto`
  - Returns: `{ type: 'howto', seen: boolean }` per user.

- POST `/api/howto`
  - Body: `{ seen: boolean }` to mark modal shown.

- GET `/api/achievements`
  - Returns: `UserAchievementsResponse` derived from current user flair and configs.

Internal/scheduled endpoints exist for post creation and leaderboard pinning.

## Leaderboard Logic

- Scopes by `dateKey` (UTC) and difficulty.
- Stores entries as JSON in Redis key: `bb:${dateKey}:lb:${difficulty}`.
- On submission:
  - If user exists, keep best (lowest) `timeMs` only.
  - After insert/update, sort ascending by `timeMs` and assign 1-based `rank`.
  - Response includes `rank` and `total`.

## Streak Logic

- Keys: `bb:streak:${username}:{last|current|best}`.
- When a user first wins on a day:
  - If `last === yesterday(dateKey)`, `current += 1`, else `current = 1`.
  - `best = max(best, current)`.
  - Update `last = dateKey`.
- Multiple wins in the same day do not increment `current`.

## Rewards & Achievements

- Achievements evaluated on each valid win using `determineAchievements`:
  - Always grant: `first_win`, `puzzle_solver`.
  - Time thresholds: `speed_demon` if time ≤ 30s (easy), 60s (medium), 120s (hard).
  - Placement tiers: `top_10` (rank ≤ 10), `top_3` (rank ≤ 3), `first_place` (rank = 1).
  - Streak-based: `streak_master` when current streak ≥ 7.
- Rewards processing is async: sets user flair per achievement, posts congratulatory comments, and best-effort threads under the daily post. Flair configs include text and colors.

## Determinism & Seeding

- RNG: Mulberry32 seeded from FNV-1a hash of `seed` string.
- `generateSolution(seed)`: backtracking fill obeying partial row/col constraints (no triples, do not exceed half of either value, if filled then balanced). If an improbable backtrack failure happens, seeds are modified (`seed + 'x'`) and retried.
- `generatePuzzle(dateKey, difficulty)`: takes a solved grid and masks cells down to the target reveal ratio.
- `generateAsciiArt('ascii:' + seed)`: picks a motif and frames it with deterministic characters.

## Auto-Submit Behavior

- The client computes `filledAndValid` via row/col checks mirroring server constraints.
- When true and not already solved and not loading, it triggers submission.
- Difficulty changes clear the grid and temporarily suppress auto-submit to avoid false triggers.

## Error Handling & Edge Cases

- If puzzle cache is missing/corrupted, server regenerates.
- Server validation does not require matching the originally generated solution; any conforming grid respecting givens is accepted.
- Leaderboard sorting is stable by time only; ties are ordered by insertion order (implementation detail of sort stability in JS V8 is not relied on explicitly, but practical behavior is acceptable here).

## Minimal Walkthrough (Example)

1. GET `/api/puzzle?difficulty=medium` → render givens.
2. Player fills grid; client ensures no triples and balance as they play.
3. Grid is full and valid → client auto-POSTs `/api/submit?difficulty=medium` with elapsed `timeMs`.
4. Server validates; returns `{ ok: true, valid: true, timeMs, rank, total, dateKey, achievements, rewardsAwarded }`.
5. Client shows confetti, ASCII modal, and updates achievements/leaderboard.

## Non-Goals

- No hints, undo stacks, or solver assistance beyond validations.
- No partial scoring; either valid or not.

## Glossary

- **Givens**: pre-filled cells.
- **No Triples**: forbid contiguous 000 or 111.
- **Balanced**: equal count of 0s and 1s per line.
- **Date Key**: UTC day identifier `YYYY-MM-DD`.
